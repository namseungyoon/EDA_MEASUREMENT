/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2024 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "adc.h"
#include "dac.h"
#include "dma.h"
#include "fatfs.h"
#include "i2c.h"
#include "spi.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "math.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define fs					128//hz


/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */
float ms = 0;
uint8_t sec = 0;
uint16_t min = 0;
uint16_t ms_idx = 0;

/* EDA variables */
float Ids[1394] = {	0.007568, 0.007568, 0.009180, 0.005151, 0.007568, 0.005151, 0.007568, 0.005151, 0.004346, 0.006763,
					0.004346, 0.005151, 0.005957, 0.007568, 0.005151, 0.005151, 0.006763, 0.003540, 0.001929, 0.004346,
					0.001929, 0.005151, 0.005957, 0.003540, 0.003540, 0.005957, 0.003540, 0.005957, 0.005957, 0.003540,
					0.004346, 0.003540, 0.004346, 0.005957, 0.006763, 0.003540, 0.005151, 0.004346, 0.003540, 0.006763,
					0.006763, 0.005151, 0.007568, 0.006763, 0.005151, 0.004346, 0.005957, 0.006763, 0.004346, 0.006763,
					0.006763, 0.006763, 0.006763, 0.007568, 0.006763, 0.007568, 0.007568, 0.005151, 0.006763, 0.006763,
					0.006763, 0.007568, 0.007568, 0.007568, 0.009180, 0.006763, 0.010791, 0.013208, 0.005151, 0.001929,
					0.001123, 0.000317, 0.001929, 0.001929, 0.003540, 0.009180, 0.008374, 0.006763, 0.006763, 0.004346,
					0.009180, 0.005151, 0.004346, 0.009180, 0.004346, 0.005957, 0.006763, 0.009985, 0.001929, 0.002734,
					0.007568, 0.005151, 0.005957, 0.006763, 0.008374, 0.003540, 0.001929, 0.006763, 0.007568, 0.004346,
					0.006763, 0.004346, 0.006763, 0.009180, 0.005151, 0.003540, 0.008374, 0.009180, 0.003540, 0.008374,
					0.007568, 0.009985, 0.009985, 0.002734, 0.013208, 0.006763, 0.001929, 0.005957, 0.008374, 0.005957,
					0.003540, 0.004346, 0.007568, 0.002734, 0.003540, 0.005151, 0.004346, 0.006763, 0.007568, 0.006763,
					0.005957, 0.002734, 0.003540, 0.008374, 0.005957, 0.002734, 0.009180, 0.005151, 0.008374, 0.005957,
					0.007568, 0.005957, 0.006763, 0.007568, 0.005151, 0.005957, 0.004346, 0.005957, 0.002734, 0.006763,
					0.007568, 0.004346, 0.003540, 0.005151, 0.001929, 0.005151, 0.005957, 0.004346, 0.005957, 0.005957,
					0.003540, 0.002734, 0.002734, 0.004346, 0.005151, 0.004346, 0.004346, 0.005151, 0.003540, 0.003540,
					0.007568, 0.009180, 0.005957, 0.005957, 0.005957, 0.003540, 0.005957, 0.004346, 0.005151, 0.006763,
					0.007568, 0.006763, 0.004346, 0.003540, 0.004346, 0.003540, 0.004346, 0.005151, 0.006763, 0.005151,
					0.005957, 0.005957, 0.005957, 0.005957, 0.006763, 0.005957, 0.005957, 0.005957, 0.006763, 0.005957,
					0.005957, 0.003540, 0.004346, 0.003540, 0.004346, 0.004346, 0.005151, 0.005957, 0.006763, 0.005957,
					0.006763, 0.005957, 0.006763, 0.004346, 0.004346, 0.004346, 0.004346, 0.005151, 0.005151, 0.006763,
					0.005957, 0.007568, 0.005957, 0.006763, 0.007568, 0.004346, 0.004346, 0.004346, 0.003540, 0.003540,
					0.004346, 0.005957, 0.006763, 0.005957, 0.005957, 0.005151, 0.005957, 0.004346, 0.007568, 0.005957,
					0.006763, 0.005957, 0.005957, 0.005957, 0.004346, 0.003540, 0.003540, 0.004346, 0.004346, 0.003540,
					0.005957, 0.007568, 0.005957, 0.006763, 0.005957, 0.006763, 0.006763, 0.004346, 0.005957, 0.006763,
					0.006763, 0.006763, 0.006763, 0.005957, 0.004346, 0.005151, 0.004346, 0.005151, 0.004346, 0.006763,
					0.007568, 0.006763, 0.007568, 0.007568, 0.005957, 0.005957, 0.004346, 0.004346, 0.006763, 0.005151,
					0.007568, 0.006763, 0.005151, 0.005151, 0.005151, 0.005151, 0.005151, 0.005151, 0.006763, 0.007568,
					0.004346, 0.004346, 0.005151, 0.004346, 0.005151, 0.008374, 0.008374, 0.009180, 0.007568, 0.007568,
					0.006763, 0.007568, 0.010791, 0.009180, 0.010791, 0.012402, 0.008374, 0.003540, 0.009180, 0.009985,
					0.009985, 0.009985, 0.005957, 0.005957, 0.009180, 0.009180, 0.004346, 0.005151, 0.007568, 0.004346,
					0.008374, 0.005957, 0.007568, 0.008374, 0.009180, 0.004346, 0.009180, 0.003540, 0.006763, 0.004346,
					0.005957, 0.004346, 0.005957, 0.006763, 0.005957, 0.010791, 0.009985, 0.006763, 0.009985, 0.009985,
					0.005957, 0.006763, 0.005151, 0.007568, 0.006763, 0.003540, 0.008374, 0.013208, 0.005151, 0.000317,
					0.009985, 0.009985, 0.009180, 0.005957, 0.005151, 0.005151, 0.004346, 0.009985, 0.000317, 0.003540,
					0.003540, 0.002734, 0.005957, 0.007568, 0.005957, 0.005957, 0.007568, 0.006763, 0.002734, 0.008374,
					0.008374, 0.009180, 0.006763, 0.005957, 0.005957, 0.008374, 0.009985, 0.006763, 0.006763, 0.004346,
					0.006763, 0.005151, 0.005957, 0.008374, 0.008374, 0.006763, 0.005151, 0.006763, 0.005957, 0.003540,
					0.006763, 0.008374, 0.005957, 0.009985, 0.009180, 0.009985, 0.009985, 0.005957, 0.009180, 0.008374,
					0.006763, 0.004346, 0.009985, 0.005151, 0.005151, 0.004346, 0.003540, 0.005151, 0.004346, 0.006763,
					0.002734, 0.004346, 0.005957, 0.009180, 0.009180, 0.003540, 0.003540, 0.003540, 0.004346, 0.009985,
					0.008374, 0.005151, 0.003540, 0.007568, 0.006763, 0.008374, 0.007568, 0.006763, 0.007568, 0.008374,
					0.007568, 0.006763, 0.005151, 0.005151, 0.005957, 0.006763, 0.008374, 0.005957, 0.005151, 0.005151,
					0.005957, 0.007568, 0.005957, 0.005151, 0.005151, 0.005151, 0.005151, 0.005957, 0.008374, 0.007568,
					0.006763, 0.005151, 0.005151, 0.005957, 0.008374, 0.005957, 0.005957, 0.005151, 0.007568, 0.008374,
					0.008374, 0.005151, 0.007568, 0.009180, 0.009180, 0.007568, 0.007568, 0.008374, 0.008374, 0.008374,
					0.008374, 0.008374, 0.009180, 0.005957, 0.008374, 0.009180, 0.009180, 0.009180, 0.005957, 0.005957,
					0.007568, 0.008374, 0.008374, 0.007568, 0.008374, 0.005957, 0.006763, 0.008374, 0.009180, 0.009180,
					0.008374, 0.006763, 0.005957, 0.006763, 0.008374, 0.007568, 0.008374, 0.006763, 0.005957, 0.008374,
					0.008374, 0.006763, 0.005957, 0.005957, 0.009180, 0.009180, 0.008374, 0.009180, 0.009180, 0.009985,
					0.008374, 0.008374, 0.007568, 0.007568, 0.009180, 0.009985, 0.009180, 0.007568, 0.009180, 0.009180,
					0.009180, 0.006763, 0.007568, 0.007568, 0.009180, 0.010791, 0.009985, 0.007568, 0.008374, 0.009985,
					0.009985, 0.011597, 0.012402, 0.010791, 0.011597, 0.010791, 0.011597, 0.007568, 0.009180, 0.011597,
					0.010791, 0.009180, 0.007568, 0.009985, 0.014819, 0.011597, 0.013208, 0.008374, 0.012402, 0.011597,
					0.014014, 0.017236, 0.004346, 0.015625, 0.018042, 0.018042, 0.009985, 0.009180, 0.011597, 0.001929,
					0.009985, 0.012402, 0.009985, 0.009985, 0.008374, 0.010791, 0.009180, 0.009985, 0.010791, 0.013208,
					0.007568, 0.009180, 0.013208, 0.010791, 0.015625, 0.012402, 0.009985, 0.008374, 0.008374, 0.009985,
					0.015625, 0.010791, 0.009985, 0.011597, 0.011597, 0.010791, 0.011597, 0.012402, 0.020459, 0.012402,
					0.009180, 0.010791, 0.018042, 0.015625, 0.015625, 0.020459, 0.014819, 0.018042, 0.008374, 0.016431,
					0.011597, 0.007568, 0.011597, 0.012402, 0.012402, 0.014014, 0.013208, 0.012402, 0.013208, 0.013208,
					0.015625, 0.011597, 0.014014, 0.017236, 0.014014, 0.011597, 0.017236, 0.014014, 0.018848, 0.010791,
					0.015625, 0.016431, 0.015625, 0.011597, 0.013208, 0.017236, 0.016431, 0.017236, 0.015625, 0.014014,
					0.016431, 0.015625, 0.018042, 0.014014, 0.015625, 0.018042, 0.016431, 0.013208, 0.016431, 0.015625,
					0.017236, 0.017236, 0.017236, 0.014014, 0.019653, 0.020459, 0.020459, 0.018042, 0.014014, 0.018848,
					0.015625, 0.014014, 0.018042, 0.017236, 0.016431, 0.017236, 0.018042, 0.016431, 0.021265, 0.020459,
					0.017236, 0.017236, 0.020459, 0.018848, 0.020459, 0.018848, 0.018848, 0.021265, 0.023682, 0.022070,
					0.024487, 0.022070, 0.020459, 0.021265, 0.022876, 0.021265, 0.019653, 0.022070, 0.022070, 0.022070,
					0.022070, 0.020459, 0.022876, 0.022876, 0.020459, 0.022070, 0.021265, 0.021265, 0.022876, 0.022876,
					0.020459, 0.021265, 0.025293, 0.024487, 0.025293, 0.025293, 0.024487, 0.024487, 0.023682, 0.026099,
					0.025293, 0.026099, 0.025293, 0.027710, 0.026904, 0.025293, 0.024487, 0.027710, 0.026904, 0.025293,
					0.029321, 0.028516, 0.027710, 0.026099, 0.027710, 0.027710, 0.027710, 0.029321, 0.030127, 0.029321,
					0.026904, 0.028516, 0.030933, 0.029321, 0.029321, 0.031738, 0.032544, 0.030933, 0.030933, 0.032544,
					0.030933, 0.030933, 0.034155, 0.034155, 0.034155, 0.033350, 0.034155, 0.034155, 0.034155, 0.033350,
					0.034155, 0.035767, 0.037378, 0.036572, 0.036572, 0.034961, 0.036572, 0.038989, 0.038184, 0.036572,
					0.037378, 0.036572, 0.038184, 0.040601, 0.040601, 0.040601, 0.038989, 0.041406, 0.038989, 0.038989,
					0.043823, 0.043823, 0.043018, 0.042212, 0.043823, 0.044629, 0.043018, 0.043018, 0.045435, 0.046240,
					0.045435, 0.046240, 0.047852, 0.047852, 0.046240, 0.045435, 0.046240, 0.050269, 0.047852, 0.048657,
					0.051880, 0.052686, 0.051074, 0.051074, 0.052686, 0.056714, 0.051074, 0.058325, 0.055908, 0.058325,
					0.056714, 0.059131, 0.051074, 0.047046, 0.051074, 0.059131, 0.050269, 0.058325, 0.059131, 0.062353,
					0.056714, 0.062353, 0.060742, 0.060742, 0.059937, 0.058325, 0.061548, 0.063965, 0.065576, 0.067993,
					0.063159, 0.061548, 0.063159, 0.068799, 0.068799, 0.068799, 0.068799, 0.072021, 0.069605, 0.067993,
					0.071216, 0.068799, 0.070410, 0.072021, 0.076855, 0.075244, 0.072021, 0.079272, 0.076855, 0.079272,
					0.082495, 0.080884, 0.081689, 0.084106, 0.086523, 0.076855, 0.088940, 0.081689, 0.088940, 0.082495,
					0.083301, 0.084912, 0.089746, 0.088135, 0.087329, 0.087329, 0.090552, 0.093774, 0.095386, 0.092969,
					0.092163, 0.092163, 0.097803, 0.099414, 0.098608, 0.099414, 0.101831, 0.101831, 0.101025, 0.102637,
					0.105859, 0.107471, 0.106665, 0.105859, 0.111499, 0.109888, 0.107471, 0.108276, 0.114722, 0.109888,
					0.110693, 0.114722, 0.115527, 0.117139, 0.117139, 0.119556, 0.121973, 0.121167, 0.123584, 0.126001,
					0.126001, 0.126001, 0.129224, 0.126807, 0.130835, 0.128418, 0.131641, 0.132446, 0.134863, 0.135669,
					0.137280, 0.142114, 0.142114, 0.141309, 0.140503, 0.145337, 0.148560, 0.150171, 0.147754, 0.152588,
					0.148560, 0.153394, 0.154199, 0.158228, 0.161450, 0.162256, 0.160645, 0.161450, 0.165479, 0.167090,
					0.170313, 0.170313, 0.173535, 0.173535, 0.174341, 0.175146, 0.179980, 0.179980, 0.181592, 0.184814,
					0.187231, 0.186426, 0.189648, 0.192871, 0.192871, 0.196899, 0.196094, 0.197705, 0.202539, 0.203345,
					0.201733, 0.206567, 0.207373, 0.210596, 0.213818, 0.216235, 0.215430, 0.217041, 0.222681, 0.222681,
					0.226709, 0.229932, 0.228320, 0.232349, 0.236377, 0.237988, 0.240405, 0.242822, 0.243628, 0.246045,
					0.250879, 0.252490, 0.253296, 0.256519, 0.259741, 0.260547, 0.265381, 0.267798, 0.270215, 0.271021,
					0.275049, 0.276660, 0.282300, 0.284717, 0.287134, 0.287134, 0.292773, 0.295190, 0.297607, 0.302441,
					0.304053, 0.305664, 0.310498, 0.314526, 0.317749, 0.320972, 0.322583, 0.325000, 0.331445, 0.334668,
					0.335474, 0.338696, 0.341919, 0.345142, 0.351587, 0.354810, 0.355615, 0.362866, 0.365283, 0.368506,
					0.370923, 0.374951, 0.380591, 0.385425, 0.386230, 0.391870, 0.395898, 0.399927, 0.405566, 0.406372,
					0.412817, 0.419263, 0.424097, 0.424097, 0.425708, 0.426514, 0.428125, 0.430542, 0.435376, 0.436987,
					0.438599, 0.439404, 0.446655, 0.449878, 0.455518, 0.457129, 0.461157, 0.463574, 0.465186, 0.471631,
					0.478076, 0.488550, 0.497412, 0.504663, 0.512720, 0.519165, 0.532056, 0.536890, 0.548169, 0.548975,
					0.550586, 0.564282, 0.562671, 0.576367, 0.580395, 0.576367, 0.594898, 0.599731, 0.610205, 0.615845,
					0.615845, 0.627930, 0.631152, 0.635986, 0.641626, 0.649683, 0.659351, 0.665796, 0.677075, 0.680298,
					0.685938, 0.693994, 0.701245, 0.709302, 0.718164, 0.721387, 0.731860, 0.739111, 0.748779, 0.753613,
					0.764893, 0.770532, 0.779395, 0.788257, 0.797119, 0.804370, 0.815649, 0.823706, 0.833374, 0.834180,
					0.851099, 0.857544, 0.868823, 0.874463, 0.880103, 0.898633, 0.904272, 0.908301, 0.918774, 0.930054,
					0.939722, 0.944556, 0.959863, 0.968726, 0.980811, 0.987256, 0.999341, 1.010620, 1.020288, 1.033984,
					1.041235, 1.052515, 1.065405, 1.073462, 1.088770, 1.094409, 1.110523, 1.119385, 1.132275, 1.148389,
					1.157251, 1.170947, 1.183032, 1.196728, 1.208008, 1.218481, 1.237012, 1.249097, 1.259570, 1.280518,
					1.295020, 1.305493, 1.320801, 1.332080, 1.344971, 1.365112, 1.378809, 1.389282, 1.408618, 1.421509,
					1.441650, 1.455347, 1.468237, 1.481128, 1.502075, 1.518188, 1.531885, 1.549609, 1.564111, 1.577808,
					1.597144, 1.617285, 1.636621, 1.651123, 1.670459, 1.688989, 1.707520, 1.726856, 1.747803, 1.766333,
					1.786475, 1.805810, 1.823535, 1.844482, 1.868652, 1.884766, 1.907324, 1.927466, 1.946802, 1.970166,
					1.994336, 2.009644, 2.037036, 2.057983, 2.087793, 2.103906, 2.119214, 2.149829, 2.162720, 2.201392,
					2.212671, 2.235229, 2.265039, 2.289209, 2.314990, 2.339966, 2.360107, 2.386694, 2.418115, 2.435840,
					2.464038, 2.497070, 2.520435, 2.545410, 2.562329, 2.588110, 2.625977, 2.665454, 2.700903, 3.193604,
					3.153321, 3.193604, 3.322509, 3.290283, 3.386963, 3.338623, 3.362793, 3.411133, 3.443359, 3.475586,
					3.507812, 3.580322, 3.628662, 3.620606, 3.685058, 3.709229, 3.773682, 3.789795, 3.830078, 3.870362,
					3.934814, 3.967041, 4.023438, 4.055664, 4.087890, 4.120118, 4.200684, 4.208740, 4.297363, 4.289306,
					4.377930, 4.442383, 4.458496, 4.522949, 4.522949, 4.611572, 4.692139, 4.708252, 4.740479, 4.740479,
					4.845215, 4.877441, 4.958008, 4.933837, 5.111084, 5.038574, 5.119140, 5.191650, 5.256103, 5.312500,
					5.352783, 5.433350, 5.473632, 5.530029, 5.586426, 5.666993, 5.723388, 5.803955, 5.868409, 6.021484,
					5.957031, 5.965087, 5.836182, 5.779785, 5.691163, 5.650879, 5.594482, 5.578369, 5.562256, 5.554199,
					5.521972, 5.570312, 5.602539, 5.602539, 5.610596, 5.666993, 5.715332, 5.755615, 5.924804, 5.981201,
					6.093994, 6.158447, 6.311524, 6.367919, 6.416260, 6.553223, 6.577393, 6.690185, 6.786865, 6.835206,
					6.915772, 7.028564, 7.036622, 7.141357, 7.229980, 7.318604, 7.366943, 7.479737, 7.568359, 7.608643,
					7.681153, 7.793945, 7.834228, 7.955078, 8.019530, 8.140381, 8.212891, 8.333740, 8.406251, 8.486816,
					8.567383, 8.728517, 8.792969, 8.857422, 8.994385, 9.091065, 9.155519, 9.236084, 9.364990, 9.477784,
					9.542236, 9.695313, 9.783936, 9.856445, 10.001465, 10.065918, 10.202881, 10.315673, 10.396240, 10.541260,
					10.662110, 10.782960, 10.871582, 11.024659, 11.113281, 11.250245, 11.363036, 11.451660, 11.580566, 11.725585,
					11.878662, 11.959229, 12.088134, 12.249268, 12.378174, 12.482910, 12.611816, 12.781006, 12.909911, 13.022705,
					13.175781, 13.296630, 13.441651, 13.602784, 13.771973, 13.884767, 14.029785, 14.190919, 14.327881, 14.497070,
					14.642090, 14.819336, 14.996582, 15.165772, 15.334961, 15.488037, 15.673339, 15.858643, 16.027832, 16.188965,
					16.366211, 16.543457, 16.760986, 16.946289, 17.147705, 17.341064, 17.510256, 17.711670, 17.921143, 18.098387,
					18.299805, 18.485107, 18.678467, 18.895994, 19.121582, 19.355225, 19.564697, 19.798342, 19.999756, 20.233398,
					20.442873, 20.708740, 20.918213, 21.143801, 21.369385, 21.578857, 21.804443, 22.038086, 22.279785, 22.561768,
					22.779297, 23.037109, 23.286865, 23.544678, 23.834717, 24.076418, 24.358400, 24.559814, 24.664551, 25.123779,
					25.607178, 26.130859, 26.590088, 26.992920};

float ln_Ids[1394] = {	-4.883779, -4.883779, -4.690760, -5.268488, -4.883779, -5.268488, -4.883779, -5.268488, -5.438565, -4.996336,
						-5.438565, -5.268488, -5.123187, -4.883779, -5.268488, -5.268488, -4.996336, -5.643618, -6.250916, -5.438565,
						-6.250916, -5.268488, -5.123187, -5.643618, -5.643618, -5.123187, -5.643618, -5.123187, -5.123187, -5.643618,
						-5.438565, -5.643618, -5.438565, -5.123187, -4.996336, -5.643618, -5.268488, -5.438565, -5.643618, -4.996336,
						-4.996336, -5.268488, -4.883779, -4.996336, -5.268488, -5.438565, -5.123187, -4.996336, -5.438565, -4.996336,
						-4.996336, -4.996336, -4.996336, -4.883779, -4.996336, -4.883779, -4.883779, -5.268488, -4.996336, -4.996336,
						-4.996336, -4.883779, -4.883779, -4.883779, -4.690760, -4.996336, -4.529042, -4.326930, -5.268488, -6.250916,
						-6.791688, -8.055365, -6.250916, -6.250916, -5.643618, -4.690760, -4.782619, -4.996336, -4.996336, -5.438565,
						-4.690760, -5.268488, -5.438565, -4.690760, -5.438565, -5.123187, -4.996336, -4.606638, -6.250916, -5.901857,
						-4.883779, -5.268488, -5.123187, -4.996336, -4.782619, -5.643618, -6.250916, -4.996336, -4.883779, -5.438565,
						-4.996336, -5.438565, -4.996336, -4.690760, -5.268488, -5.643618, -4.782619, -4.690760, -5.643618, -4.782619,
						-4.883779, -4.606638, -4.606638, -5.901857, -4.326930, -4.996336, -6.250916, -5.123187, -4.782619, -5.123187,
						-5.643618, -5.438565, -4.883779, -5.901857, -5.643618, -5.268488, -5.438565, -4.996336, -4.883779, -4.996336,
						-5.123187, -5.901857, -5.643618, -4.782619, -5.123187, -5.901857, -4.690760, -5.268488, -4.782619, -5.123187,
						-4.883779, -5.123187, -4.996336, -4.883779, -5.268488, -5.123187, -5.438565, -5.123187, -5.901857, -4.996336,
						-4.883779, -5.438565, -5.643618, -5.268488, -6.250916, -5.268488, -5.123187, -5.438565, -5.123187, -5.123187,
						-5.643618, -5.901857, -5.901857, -5.438565, -5.268488, -5.438565, -5.438565, -5.268488, -5.643618, -5.643618,
						-4.883779, -4.690760, -5.123187, -5.123187, -5.123187, -5.643618, -5.123187, -5.438565, -5.268488, -4.996336,
						-4.883779, -4.996336, -5.438565, -5.643618, -5.438565, -5.643618, -5.438565, -5.268488, -4.996336, -5.268488,
						-5.123187, -5.123187, -5.123187, -5.123187, -4.996336, -5.123187, -5.123187, -5.123187, -4.996336, -5.123187,
						-5.123187, -5.643618, -5.438565, -5.643618, -5.438565, -5.438565, -5.268488, -5.123187, -4.996336, -5.123187,
						-4.996336, -5.123187, -4.996336, -5.438565, -5.438565, -5.438565, -5.438565, -5.268488, -5.268488, -4.996336,
						-5.123187, -4.883779, -5.123187, -4.996336, -4.883779, -5.438565, -5.438565, -5.438565, -5.643618, -5.643618,
						-5.438565, -5.123187, -4.996336, -5.123187, -5.123187, -5.268488, -5.123187, -5.438565, -4.883779, -5.123187,
						-4.996336, -5.123187, -5.123187, -5.123187, -5.438565, -5.643618, -5.643618, -5.438565, -5.438565, -5.643618,
						-5.123187, -4.883779, -5.123187, -4.996336, -5.123187, -4.996336, -4.996336, -5.438565, -5.123187, -4.996336,
						-4.996336, -4.996336, -4.996336, -5.123187, -5.438565, -5.268488, -5.438565, -5.268488, -5.438565, -4.996336,
						-4.883779, -4.996336, -4.883779, -4.883779, -5.123187, -5.123187, -5.438565, -5.438565, -4.996336, -5.268488,
						-4.883779, -4.996336, -5.268488, -5.268488, -5.268488, -5.268488, -5.268488, -5.268488, -4.996336, -4.883779,
						-5.438565, -5.438565, -5.268488, -5.438565, -5.268488, -4.782619, -4.782619, -4.690760, -4.883779, -4.883779,
						-4.996336, -4.883779, -4.529042, -4.690760, -4.529042, -4.389869, -4.782619, -5.643618, -4.690760, -4.606638,
						-4.606638, -4.606638, -5.123187, -5.123187, -4.690760, -4.690760, -5.438565, -5.268488, -4.883779, -5.438565,
						-4.782619, -5.123187, -4.883779, -4.782619, -4.690760, -5.438565, -4.690760, -5.643618, -4.996336, -5.438565,
						-5.123187, -5.438565, -5.123187, -4.996336, -5.123187, -4.529042, -4.606638, -4.996336, -4.606638, -4.606638,
						-5.123187, -4.996336, -5.268488, -4.883779, -4.996336, -5.643618, -4.782619, -4.326930, -5.268488, -8.055365,
						-4.606638, -4.606638, -4.690760, -5.123187, -5.268488, -5.268488, -5.438565, -4.606638, -8.055365, -5.643618,
						-5.643618, -5.901857, -5.123187, -4.883779, -5.123187, -5.123187, -4.883779, -4.996336, -5.901857, -4.782619,
						-4.782619, -4.690760, -4.996336, -5.123187, -5.123187, -4.782619, -4.606638, -4.996336, -4.996336, -5.438565,
						-4.996336, -5.268488, -5.123187, -4.782619, -4.782619, -4.996336, -5.268488, -4.996336, -5.123187, -5.643618,
						-4.996336, -4.782619, -5.123187, -4.606638, -4.690760, -4.606638, -4.606638, -5.123187, -4.690760, -4.782619,
						-4.996336, -5.438565, -4.606638, -5.268488, -5.268488, -5.438565, -5.643618, -5.268488, -5.438565, -4.996336,
						-5.901857, -5.438565, -5.123187, -4.690760, -4.690760, -5.643618, -5.643618, -5.643618, -5.438565, -4.606638,
						-4.782619, -5.268488, -5.643618, -4.883779, -4.996336, -4.782619, -4.883779, -4.996336, -4.883779, -4.782619,
						-4.883779, -4.996336, -5.268488, -5.268488, -5.123187, -4.996336, -4.782619, -5.123187, -5.268488, -5.268488,
						-5.123187, -4.883779, -5.123187, -5.268488, -5.268488, -5.268488, -5.268488, -5.123187, -4.782619, -4.883779,
						-4.996336, -5.268488, -5.268488, -5.123187, -4.782619, -5.123187, -5.123187, -5.268488, -4.883779, -4.782619,
						-4.782619, -5.268488, -4.883779, -4.690760, -4.690760, -4.883779, -4.883779, -4.782619, -4.782619, -4.782619,
						-4.782619, -4.782619, -4.690760, -5.123187, -4.782619, -4.690760, -4.690760, -4.690760, -5.123187, -5.123187,
						-4.883779, -4.782619, -4.782619, -4.883779, -4.782619, -5.123187, -4.996336, -4.782619, -4.690760, -4.690760,
						-4.782619, -4.996336, -5.123187, -4.996336, -4.782619, -4.883779, -4.782619, -4.996336, -5.123187, -4.782619,
						-4.782619, -4.996336, -5.123187, -5.123187, -4.690760, -4.690760, -4.782619, -4.690760, -4.690760, -4.606638,
						-4.782619, -4.782619, -4.883779, -4.883779, -4.690760, -4.606638, -4.690760, -4.883779, -4.690760, -4.690760,
						-4.690760, -4.996336, -4.883779, -4.883779, -4.690760, -4.529042, -4.606638, -4.883779, -4.782619, -4.606638,
						-4.606638, -4.457036, -4.389869, -4.529042, -4.457036, -4.529042, -4.457036, -4.883779, -4.690760, -4.457036,
						-4.529042, -4.690760, -4.883779, -4.606638, -4.211823, -4.457036, -4.326930, -4.782619, -4.389869, -4.457036,
						-4.267724, -4.060735, -5.438565, -4.158883, -4.015055, -4.015055, -4.606638, -4.690760, -4.457036, -6.250916,
						-4.606638, -4.389869, -4.606638, -4.606638, -4.782619, -4.529042, -4.690760, -4.606638, -4.529042, -4.326930,
						-4.883779, -4.690760, -4.326930, -4.529042, -4.158883, -4.389869, -4.606638, -4.782619, -4.782619, -4.606638,
						-4.158883, -4.529042, -4.606638, -4.457036, -4.457036, -4.529042, -4.457036, -4.389869, -3.889333, -4.389869,
						-4.690760, -4.529042, -4.015055, -4.158883, -4.158883, -3.889333, -4.211823, -4.015055, -4.782619, -4.108605,
						-4.457036, -4.883779, -4.457036, -4.389869, -4.389869, -4.267724, -4.326930, -4.389869, -4.326930, -4.326930,
						-4.158883, -4.457036, -4.267724, -4.060735, -4.267724, -4.457036, -4.060735, -4.267724, -3.971367, -4.529042,
						-4.158883, -4.108605, -4.158883, -4.457036, -4.326930, -4.060735, -4.108605, -4.060735, -4.158883, -4.267724,
						-4.108605, -4.158883, -4.015055, -4.267724, -4.158883, -4.015055, -4.108605, -4.326930, -4.108605, -4.158883,
						-4.060735, -4.060735, -4.060735, -4.267724, -3.929509, -3.889333, -3.889333, -4.015055, -4.267724, -3.971367,
						-4.158883, -4.267724, -4.015055, -4.060735, -4.108605, -4.060735, -4.015055, -4.108605, -3.850708, -3.889333,
						-4.060735, -4.060735, -3.889333, -3.971367, -3.889333, -3.971367, -3.971367, -3.850708, -3.743055, -3.813523,
						-3.709600, -3.813523, -3.889333, -3.850708, -3.777668, -3.850708, -3.929509, -3.813523, -3.813523, -3.813523,
						-3.813523, -3.889333, -3.777668, -3.777668, -3.889333, -3.813523, -3.850708, -3.850708, -3.777668, -3.777668,
						-3.889333, -3.850708, -3.677228, -3.709600, -3.677228, -3.677228, -3.709600, -3.709600, -3.743055, -3.645873,
						-3.677228, -3.645873, -3.677228, -3.585963, -3.615470, -3.677228, -3.709600, -3.585963, -3.615470, -3.677228,
						-3.529441, -3.557303, -3.585963, -3.645873, -3.585963, -3.585963, -3.585963, -3.529441, -3.502336, -3.529441,
						-3.615470, -3.557303, -3.475945, -3.529441, -3.529441, -3.450232, -3.425164, -3.475945, -3.475945, -3.425164,
						-3.475945, -3.475945, -3.376839, -3.376839, -3.376839, -3.400708, -3.376839, -3.376839, -3.376839, -3.400708,
						-3.376839, -3.330741, -3.286674, -3.308465, -3.308465, -3.353524, -3.308465, -3.244469, -3.265350, -3.308465,
						-3.286674, -3.308465, -3.265350, -3.203973, -3.203973, -3.203973, -3.244469, -3.184323, -3.244469, -3.244469,
						-3.127591, -3.127591, -3.146147, -3.165053, -3.127591, -3.109373, -3.146147, -3.146147, -3.091481, -3.073905,
						-3.091481, -3.073905, -3.039651, -3.039651, -3.073905, -3.091481, -3.073905, -2.990376, -3.039651, -3.022955,
						-2.958824, -2.943414, -2.974476, -2.974476, -2.943414, -2.869736, -2.974476, -2.841722, -2.884044, -2.841722,
						-2.869736, -2.828002, -2.974476, -3.056632, -2.974476, -2.828002, -2.990376, -2.841722, -2.828002, -2.774936,
						-2.869736, -2.774936, -2.801117, -2.801117, -2.814469, -2.841722, -2.787940, -2.749422, -2.724543, -2.688348,
						-2.762097, -2.787940, -2.762097, -2.676569, -2.676569, -2.676569, -2.676569, -2.630791, -2.664926, -2.688348,
						-2.642040, -2.676569, -2.653418, -2.630791, -2.565829, -2.587017, -2.630791, -2.534865, -2.565829, -2.534865,
						-2.495017, -2.514742, -2.504830, -2.475672, -2.447340, -2.565829, -2.419788, -2.504830, -2.419788, -2.495017,
						-2.485297, -2.466138, -2.410770, -2.428888, -2.438072, -2.438072, -2.401834, -2.366863, -2.349826, -2.375492,
						-2.384196, -2.384196, -2.324802, -2.308462, -2.316599, -2.308462, -2.284440, -2.284440, -2.292383, -2.276560,
						-2.245643, -2.230537, -2.238062, -2.245643, -2.193740, -2.208296, -2.230537, -2.223068, -2.165246, -2.208296,
						-2.200992, -2.165246, -2.158248, -2.144397, -2.144397, -2.123973, -2.103958, -2.110585, -2.090834, -2.071465,
						-2.071465, -2.071465, -2.046211, -2.065092, -2.033819, -2.052465, -2.027680, -2.021578, -2.003494, -1.997538,
						-1.985731, -1.951124, -1.951124, -1.956809, -1.962527, -1.928701, -1.906769, -1.895981, -1.912207, -1.880015,
						-1.906769, -1.874748, -1.869510, -1.843721, -1.823558, -1.818581, -1.828561, -1.823558, -1.798914, -1.789224,
						-1.770120, -1.770120, -1.751375, -1.751375, -1.746743, -1.742133, -1.714907, -1.714907, -1.705994, -1.688403,
						-1.675410, -1.679722, -1.662583, -1.645733, -1.645733, -1.625062, -1.629162, -1.620979, -1.596822, -1.592853,
						-1.600808, -1.577129, -1.573236, -1.557815, -1.542628, -1.531388, -1.535121, -1.527669, -1.502016, -1.502016,
						-1.484088, -1.469973, -1.477006, -1.459516, -1.442327, -1.435534, -1.425429, -1.415425, -1.412113, -1.402241,
						-1.382785, -1.376383, -1.373197, -1.360554, -1.348070, -1.344972, -1.326589, -1.317523, -1.308538, -1.305561,
						-1.290807, -1.284965, -1.264786, -1.256260, -1.247807, -1.247807, -1.228356, -1.220134, -1.211980, -1.195868,
						-1.190554, -1.185269, -1.169578, -1.156687, -1.146493, -1.136402, -1.131395, -1.123930, -1.104292, -1.094616,
						-1.092212, -1.082651, -1.073182, -1.063801, -1.045298, -1.036174, -1.033906, -1.013721, -1.007082, -0.998299,
						-0.991761, -0.980959, -0.966031, -0.953409, -0.951321, -0.936825, -0.926598, -0.916474, -0.902471, -0.900486,
						-0.884750, -0.869258, -0.857794, -0.857794, -0.854002, -0.852111, -0.848340, -0.842710, -0.831545, -0.827851,
						-0.824171, -0.822335, -0.805968, -0.798779, -0.786321, -0.782790, -0.774016, -0.768789, -0.765319, -0.751559,
						-0.737985, -0.716314, -0.698336, -0.683864, -0.668026, -0.655533, -0.631007, -0.621963, -0.601172, -0.599703,
						-0.596772, -0.572201, -0.575060, -0.551010, -0.544046, -0.551010, -0.519366, -0.511273, -0.493960, -0.484760,
						-0.484760, -0.465327, -0.460208, -0.452578, -0.443750, -0.431271, -0.416500, -0.406772, -0.389973, -0.385225,
						-0.376969, -0.365292, -0.354898, -0.343474, -0.331057, -0.326580, -0.312165, -0.302307, -0.289311, -0.282876,
						-0.268020, -0.260674, -0.249238, -0.237931, -0.226751, -0.217696, -0.203771, -0.193942, -0.182273, -0.181307,
						-0.161227, -0.153683, -0.140616, -0.134146, -0.127717, -0.106881, -0.100625, -0.096180, -0.084715, -0.072513,
						-0.062172, -0.057041, -0.040964, -0.031774, -0.019376, -0.012826, -0.000659, 0.010564, 0.020085, 0.033420,
						0.040408, 0.051182, 0.063355, 0.070889, 0.085048, 0.090215, 0.104831, 0.112779, 0.124229, 0.138360,
						0.146047, 0.157813, 0.168081, 0.179592, 0.188972, 0.197605, 0.212699, 0.222421, 0.230771, 0.247264,
						0.258526, 0.266581, 0.278238, 0.286742, 0.296372, 0.311237, 0.321220, 0.328787, 0.342609, 0.351719,
						0.365789, 0.375244, 0.384063, 0.392804, 0.406848, 0.417518, 0.426499, 0.438003, 0.447318, 0.456036,
						0.468217, 0.480749, 0.492634, 0.501456, 0.513098, 0.524130, 0.535042, 0.546302, 0.558359, 0.568906,
						0.580244, 0.591009, 0.600777, 0.612199, 0.625217, 0.633803, 0.645701, 0.656206, 0.666188, 0.678118,
						0.690311, 0.697957, 0.711496, 0.721727, 0.736107, 0.743796, 0.751045, 0.765388, 0.771367, 0.789090,
						0.794200, 0.804344, 0.817592, 0.828206, 0.839405, 0.850136, 0.858707, 0.869909, 0.882988, 0.890292,
						0.901802, 0.915118, 0.924431, 0.934292, 0.940917, 0.950928, 0.965453, 0.980374, 0.993586, 1.161150,
						1.148456, 1.161150, 1.200720, 1.190974, 1.219934, 1.205558, 1.212772, 1.227044, 1.236447, 1.245763,
						1.254993, 1.275453, 1.288864, 1.286641, 1.304286, 1.310824, 1.328051, 1.332312, 1.342885, 1.353348,
						1.369864, 1.378020, 1.392137, 1.400114, 1.408029, 1.415882, 1.435247, 1.437163, 1.458002, 1.456125,
						1.476576, 1.491191, 1.494812, 1.509164, 1.509164, 1.528569, 1.545889, 1.549317, 1.556138, 1.556138,
						1.577992, 1.584621, 1.601004, 1.596117, 1.631412, 1.617123, 1.632986, 1.647052, 1.659390, 1.670063,
						1.677617, 1.692556, 1.699942, 1.710193, 1.720340, 1.734659, 1.744561, 1.758540, 1.769583, 1.795334,
						1.784572, 1.785924, 1.764077, 1.754367, 1.738914, 1.731811, 1.721781, 1.718896, 1.716004, 1.714554,
						1.708735, 1.717451, 1.723220, 1.723220, 1.724657, 1.734659, 1.743152, 1.750176, 1.779148, 1.788621,
						1.807304, 1.817825, 1.842377, 1.851273, 1.858835, 1.879957, 1.883639, 1.900642, 1.914989, 1.922087,
						1.933805, 1.949983, 1.951128, 1.965903, 1.978236, 1.990420, 1.997003, 2.012197, 2.023976, 2.029285,
						2.038770, 2.053347, 2.058502, 2.073811, 2.081880, 2.096837, 2.105705, 2.120312, 2.128976, 2.138514,
						2.147962, 2.166595, 2.173952, 2.181256, 2.196600, 2.207292, 2.214357, 2.223118, 2.236978, 2.248950,
						2.255728, 2.271643, 2.280742, 2.288126, 2.302732, 2.309155, 2.322670, 2.333664, 2.341444, 2.355297,
						2.366696, 2.377967, 2.386152, 2.400135, 2.408141, 2.420390, 2.430366, 2.438135, 2.449328, 2.461773,
						2.474744, 2.481503, 2.492224, 2.505466, 2.515935, 2.524360, 2.534634, 2.547960, 2.557995, 2.566694,
						2.578380, 2.587511, 2.598358, 2.610275, 2.622636, 2.630792, 2.641183, 2.652602, 2.662207, 2.673947,
						2.683900, 2.695933, 2.707822, 2.719041, 2.730135, 2.740068, 2.751961, 2.763715, 2.774327, 2.784330,
						2.795219, 2.805991, 2.819054, 2.830049, 2.841864, 2.853077, 2.862787, 2.874224, 2.885981, 2.895823,
						2.906890, 2.916965, 2.927371, 2.938950, 2.950818, 2.962962, 2.973727, 2.985598, 2.995720, 3.007335,
						3.017634, 3.030556, 3.040620, 3.051347, 3.061959, 3.071714, 3.082114, 3.092772, 3.103680, 3.116257,
						3.125852, 3.137106, 3.147889, 3.158900, 3.171143, 3.181233, 3.192877, 3.201112, 3.205367, 3.223815,
						3.242873, 3.263117, 3.280539, 3.295575};

int n_Ids = 1394;

uint8_t degree = 5;

float A[1394][6] = {0,};
float B[1394][1] ={0, };
float B_[1394][1] ={0, };
float ln_Ids_[1394] = {0,};
float Ids_[1394] = {0,};

float x = 0;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_SPI5_Init();
  MX_FATFS_Init();
  MX_ADC1_Init();
  MX_DAC_Init();
  MX_I2C1_Init();
  MX_I2C2_Init();
  MX_I2C3_Init();
  MX_TIM3_Init();
  MX_USART1_UART_Init();
  /* USER CODE BEGIN 2 */
//  HAL_TIM_Base_Start_IT(&htim3);

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {





    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE3);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI|RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 4;
  RCC_OscInitStruct.PLL.PLLN = 128;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 2;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV8;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    Error_Handler();
  }
}

/* USER CODE BEGIN 4 */
int _write(int32_t file, uint8_t *ptr, int32_t len)
{
	HAL_UART_Transmit(&huart1, ptr, len, 20);

	return len;
}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	if(htim->Instance == TIM3)
	{
		ms = (float)ms_idx/fs;

		printf("%dm %.3fs\r\n", min, sec+ms);
		if(ms_idx >= fs)
		{
			ms_idx = 0;
			sec++;

			if(sec >= 60)
			{
				sec = 0;
				min++;
			}
		}
		ms_idx++;
	}
}

// Modeling Ids
void Modeling_least_square(float Ids, int N, int order, float Ids_)
{
	for(int i_Ids = 0; i_Ids < n_Ids; i_Ids++)
	{
		x = (float)i_Ids;
		A[i_Ids][5] = x * x * x * x * x;
		A[i_Ids][4] = x * x * x * x;
		A[i_Ids][3] = x * x * x;
		A[i_Ids][2] = x * x;
		A[i_Ids][1] = x;
		A[i_Ids][0] = 1;

		B[i_Ids][1] = ln_Ids[i_Ids];

	//		  printf("%d\t%f\t%f\t%f\t%f\t%f\t%f\r\n", i_Ids, X[i_Ids][5], X[i_Ids][4], X[i_Ids][3], X[i_Ids][2], X[i_Ids][1], X[i_Ids][0]);
	}

	//	  float A[7][2] = { {1, 1},
	//			  	  	  	{2, 1},
	//						{3, 1},
	//						{4, 1},
	//						{5, 1},
	//						{6, 1},
	//						{7, 1},
	//						{7, 1} };
	float A_T[6][1394] = {0, };
	float A_T_A[6][6] = {0, };
	float A_T_A_I[6][6] = {0, };
	float A_T_A_I_A_T[6][1394] = {0, };

	float X[6][1] = {0, };

	/* Least Square fitting
	* AX = B
	* X = A^(-1)B
	*   = ( A^(T)A )^(-1)A^(T)B
	*/
	transpose_matrix(1394, 6, A, A_T);

	multiply_matrices(6, 1394, A_T, 1394, 6, A, A_T_A);

	inverse_matrix(6, A_T_A, A_T_A_I);

	multiply_matrices(6, 6, A_T_A_I, 6, 1394, A_T, A_T_A_I_A_T);

	multiply_matrices(6, 1394, A_T_A_I_A_T, 1394, 1, B, X);

	multiply_matrices(1394, 6, A, 6, 1, X, B_);
	print_matrix(1394, 1, B_);

	for(int i_Ids=0; i_Ids<n_Ids; i_Ids++)
	{
		ln_Ids_[i_Ids] = B_[i_Ids][0];
		Ids_[i_Ids] = exp(ln_Ids_[i_Ids]);
	}
}

// Function to calculate the transpose of a matrix
void transpose_matrix(int rows, int cols, float A[rows][cols], float A_transpose[cols][rows]) {
    int i, j;

    for (i = 0; i < rows; i++)
    {
        for (j = 0; j < cols; j++)
        {
            A_transpose[j][i] = A[i][j]; // Swap rows and columns to assign
        }
    }
}

// Function to calculate the product of two matrices
void multiply_matrices(int rows1, int cols1, float A[rows1][cols1], int rows2, int cols2, float B[rows2][cols2], float result[rows1][cols2]) {
    int i, j, k;

    if (cols1 != rows2)
    {
        printf("Error: Number of columns in the first matrix must be equal to the number of rows in the second matrix.\n");
        return;
    }

    for (i = 0; i < rows1; i++)
    {
        for (j = 0; j < cols2; j++)
        {
            result[i][j] = 0; // Initialize the result matrix
            for (k = 0; k < cols1; k++)
            {
                result[i][j] += A[i][k] * B[k][j]; // Matrix multiplication
            }
        }
    }
}

// Function to calculate the inverse of a matrix
void inverse_matrix(int N, float A[N][N], float A_inv[N][N])
{
	float temp[N][2*N]; // Matrix combining the original matrix and the identity matrix
	float factor;

    // Initialize the temp matrix
    for (int i = 0; i < N; i++)
    {
        for (int j = 0; j < 2*N; j++)
        {
            if (j < N)
            {
                temp[i][j] = A[i][j];
            }
            else
            {
                if (j - N == i)
                {
                    temp[i][j] = 1; // Initialize the identity matrix part
                }
                else
                {
                    temp[i][j] = 0;
                }
            }
        }
    }

    // Gaussian elimination
    for (int i = 0; i < N; i++)
    {
        // If the diagonal element is 0, swap rows
        if (temp[i][i] == 0)
        {
            for (int j = i + 1; j < N; j++)
            {
                if (temp[j][i] != 0)
                {
                    // Swap rows
                    for (int k = 0; k < 2*N; k++)
                    {
                    	float temp_swap = temp[i][k];
                        temp[i][k] = temp[j][k];
                        temp[j][k] = temp_swap;
                    }
                    break;
                }
            }
        }
        // Make the diagonal element 1
        factor = temp[i][i];
        for (int j = 0; j < 2*N; j++)
        {
            temp[i][j] /= factor;
        }
        // Make other elements in the same column 0
        for (int j = 0; j < N; j++)
        {
            if (i != j)
            {
                factor = temp[j][i];
                for (int k = 0; k < 2*N; k++)
                {
                    temp[j][k] -= factor * temp[i][k];
                }
            }
        }
    }

    // Extract the inverse matrix
    for (int i = 0; i < N; i++)
    {
        for (int j = 0; j < N; j++)
        {
            A_inv[i][j] = temp[i][j+N];
        }
    }
}

// Function to print a matrix
void print_matrix(int rows, int cols, float matrix[rows][cols]) {
    int i, j;
    for (i = 0; i < rows; i++)
    {
        for (j = 0; j < cols; j++)
        {
            printf("%f ", matrix[i][j]);
        }
        printf("\r\n");
    }
}


/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
